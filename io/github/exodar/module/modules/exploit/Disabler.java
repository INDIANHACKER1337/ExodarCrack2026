/////
///// THIS SHIT WAS LEAKED BY INDIAN HACKER 1337 & jsexp ImLegiitXD LOL!
/////
/////
/////
package io.github.exodar.module.modules.exploit;

import io.github.exodar.module.Module;
import io.github.exodar.module.ModuleCategory;
import io.github.exodar.setting.DescriptionSetting;
import io.github.exodar.setting.ModeSetting;
import io.github.exodar.setting.SliderSetting;
import io.github.exodar.setting.TickSetting;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.status.client.C01PacketPing;

import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Random;

/**
 * Disabler - Exploits anticheats
 *
 * Modes:
 * - Verus: Cancel sprint packets, force sprint, set client brand to Lunar
 * - C06->C04: Convert position+look packets to position-only
 * - C04->C06: Convert position-only packets to position+look
 *
 * Options:
 * - PingSpoof: Delay C00PacketKeepAlive packets
 * - C01PacketPing: Cancel ping packets
 * - C13PlayerAbilities: Cancel abilities packets
 * - C0FConfirmTransaction: Cancel transaction packets
 * - C0BEntityAction: Cancel entity action packets (sprint/sneak)
 */
public class Disabler extends Module {

    // Mode constants
    private static final String MODE_VERUS = "Verus";
    private static final String MODE_VERUS2 = "Verus2";
    private static final String MODE_VERUS3 = "Verus3";
    private static final String MODE_C06_TO_C04 = "C06->C04";
    private static final String MODE_C04_TO_C06 = "C04->C06";

    // Settings
    private final ModeSetting mode;
    private final TickSetting pingSpoof;
    private final SliderSetting pingSpoofDelay;
    private final TickSetting cancelC01Ping;
    private final TickSetting cancelC13Abilities;
    private final TickSetting cancelC0FTransaction;
    private final TickSetting cancelC0BEntityAction;

    // Verus2 settings
    private final TickSetting verus2Movement;
    private final TickSetting verus2Sprint;

    // PingSpoof packet queue
    private final List<DelayedPacket> delayedKeepAlives = new ArrayList<>();
    private final Random random = new Random();

    // Verus2 state
    private final List<Packet<?>> verus2Transactions = new ArrayList<>();
    private final List<DelayedPacket> verus2KeepAlives = new ArrayList<>();
    private long verus2LastSend = 0;
    private int verus2Ticks = 0;

    // Gothaj state
    private final List<Packet<?>> gothajPackets = new ArrayList<>();
    private boolean gothajDisabled = false;
    private boolean gothajUsingItem = false;

    // Reflection for client brand
    private static Field clientBrandField = null;
    private static boolean reflectionInitialized = false;

    // Reflection for packet fields
    private static Field c06PosXField, c06PosYField, c06PosZField, c06OnGroundField;
    private static Field c04PosXField, c04PosYField, c04PosZField, c04OnGroundField;
    private static boolean packetReflectionInitialized = false;

    public Disabler() {
        super("Disabler", ModuleCategory.MISC);

        this.registerSetting(new DescriptionSetting("Exploit anticheats"));
        this.registerSetting(mode = new ModeSetting("Mode", new String[]{
            MODE_VERUS, MODE_VERUS2, MODE_VERUS3, MODE_C06_TO_C04, MODE_C04_TO_C06
        }));

        // Verus2 specific settings
        this.registerSetting(verus2Movement = new TickSetting("Movement", false));
        this.registerSetting(verus2Sprint = new TickSetting("Sprint", true));

        this.registerSetting(new DescriptionSetting("-- Packet Options --"));
        this.registerSetting(pingSpoof = new TickSetting("PingSpoof", false));
        this.registerSetting(pingSpoofDelay = new SliderSetting("Spoof Delay", 1000, 1, 4000, 100));
        this.registerSetting(cancelC01Ping = new TickSetting("C01PacketPing", false));
        this.registerSetting(cancelC13Abilities = new TickSetting("C13PlayerAbilities", false));
        this.registerSetting(cancelC0FTransaction = new TickSetting("C0FConfirmTransaction", false));
        this.registerSetting(cancelC0BEntityAction = new TickSetting("C0BEntityAction", false));

        // Update visibility when mode changes
        mode.onChange(this::updateSettingsVisibility);
        // Set initial visibility
        updateSettingsVisibility();

        initReflection();
        initPacketReflection();
    }

    /**
     * Update settings visibility based on selected mode
     */
    private void updateSettingsVisibility() {
        boolean isVerus2 = mode.getSelected().equals(MODE_VERUS2);
        verus2Movement.setVisible(isVerus2);
        verus2Sprint.setVisible(isVerus2);
        // pingSpoofDelay always visible since TickSetting doesn't support onChange
    }

    private void initReflection() {
        if (reflectionInitialized) return;
        reflectionInitialized = true;

        try {
            // Find clientBrand field in EntityPlayerSP
            for (Field f : EntityPlayerSP.class.getDeclaredFields()) {
                if (f.getType() == String.class) {
                    String name = f.getName().toLowerCase();
                    if (name.contains("brand") || name.equals("field_175159_w")) {
                        f.setAccessible(true);
                        clientBrandField = f;
                        break;
                    }
                }
            }
        } catch (Exception e) {
            // Silent
        }
    }

    private void initPacketReflection() {
        if (packetReflectionInitialized) return;
        packetReflectionInitialized = true;

        try {
            // C06PacketPlayerPosLook fields
            for (Field f : C03PacketPlayer.C06PacketPlayerPosLook.class.getDeclaredFields()) {
                f.setAccessible(true);
            }
            for (Field f : C03PacketPlayer.class.getDeclaredFields()) {
                f.setAccessible(true);
                String name = f.getName().toLowerCase();
                if (f.getType() == double.class) {
                    if (name.contains("x") || name.equals("field_149479_a")) c06PosXField = f;
                    else if (name.contains("y") || name.equals("field_149477_b")) c06PosYField = f;
                    else if (name.contains("z") || name.equals("field_149478_c")) c06PosZField = f;
                } else if (f.getType() == boolean.class) {
                    if (name.contains("ground") || name.equals("field_149474_g")) c06OnGroundField = f;
                }
            }

            // Use same fields for C04
            c04PosXField = c06PosXField;
            c04PosYField = c06PosYField;
            c04PosZField = c06PosZField;
            c04OnGroundField = c06OnGroundField;

        } catch (Exception e) {
            // Silent
        }
    }

    @Override
    public void onEnable() {
        delayedKeepAlives.clear();
        verus2Transactions.clear();
        verus2KeepAlives.clear();
        verus2Ticks = 0;
        gothajPackets.clear();
        gothajDisabled = false;
        gothajUsingItem = false;
    }

    @Override
    public void onDisable() {
        // Send any remaining delayed packets
        EntityPlayerSP player = getPlayer();
        if (player != null && player.sendQueue != null) {
            for (DelayedPacket dp : delayedKeepAlives) {
                player.sendQueue.addToSendQueue(new C00PacketKeepAlive(dp.key));
            }
            // Verus2 queued packets
            for (Packet<?> p : verus2Transactions) {
                player.sendQueue.addToSendQueue(p);
            }
            for (DelayedPacket dp : verus2KeepAlives) {
                player.sendQueue.addToSendQueue(new C00PacketKeepAlive(dp.key));
            }
            // Verus3 queued packets
            for (Packet<?> p : gothajPackets) {
                player.sendQueue.addToSendQueue(p);
            }
        }
        delayedKeepAlives.clear();
        verus2Transactions.clear();
        verus2KeepAlives.clear();
        gothajPackets.clear();
    }

    @Override
    public void onUpdate() {
        EntityPlayerSP player = getPlayer();
        if (player == null) return;

        String currentMode = mode.getSelected();
        verus2Ticks++;

        // Verus mode: force sprint
        if (currentMode.equals(MODE_VERUS)) {
            player.setSprinting(true);
        }

        // Verus2 mode
        if (currentMode.equals(MODE_VERUS2)) {
            // Movement disabler: send position packet every 100 ticks
            if (verus2Movement.isEnabled() && verus2Ticks % 100 == 0) {
                if (player.sendQueue != null) {
                    player.sendQueue.addToSendQueue(
                        new C03PacketPlayer.C04PacketPlayerPosition(player.posX, player.posY, player.posZ, player.onGround)
                    );
                }
            }

            // Sprint disabler: alternate start/stop sprint every 10 ticks (less spam)
            if (verus2Sprint.isEnabled() && verus2Ticks % 10 == 0) {
                if (player.sendQueue != null) {
                    if ((verus2Ticks / 10) % 2 == 0) {
                        player.sendQueue.addToSendQueue(
                            new C0BPacketEntityAction(player, C0BPacketEntityAction.Action.START_SPRINTING)
                        );
                    } else {
                        player.sendQueue.addToSendQueue(
                            new C0BPacketEntityAction(player, C0BPacketEntityAction.Action.STOP_SPRINTING)
                        );
                    }
                }
            }
        }

        // Process delayed packets only every 5 ticks to reduce lag
        if (verus2Ticks % 5 != 0) return;

        long currentTime = System.currentTimeMillis();

        // Process Verus2 delayed packets
        if (currentMode.equals(MODE_VERUS2) && player.sendQueue != null) {
            // Process one transaction
            if (!verus2Transactions.isEmpty() && currentTime - verus2LastSend >= 500) {
                player.sendQueue.addToSendQueue(verus2Transactions.remove(0));
            }

            // Process keepalives
            while (!verus2KeepAlives.isEmpty() && verus2KeepAlives.get(0).sendTime <= currentTime) {
                DelayedPacket dp = verus2KeepAlives.remove(0);
                player.sendQueue.addToSendQueue(new C00PacketKeepAlive(dp.key));
            }
        }

        // Process PingSpoof delayed packets
        if (pingSpoof.isEnabled() && !delayedKeepAlives.isEmpty() && player.sendQueue != null) {
            while (!delayedKeepAlives.isEmpty() && delayedKeepAlives.get(0).sendTime <= currentTime) {
                DelayedPacket dp = delayedKeepAlives.remove(0);
                player.sendQueue.addToSendQueue(new C00PacketKeepAlive(dp.key));
            }
        }

        // Prevent list overflow (max 100 packets queued)
        while (delayedKeepAlives.size() > 100) delayedKeepAlives.remove(0);
        while (verus2Transactions.size() > 100) verus2Transactions.remove(0);
        while (verus2KeepAlives.size() > 100) verus2KeepAlives.remove(0);
    }

    @Override
    public boolean onSendPacket(Object packet) {
        if (!enabled) return true;

        EntityPlayerSP player = getPlayer();
        if (player == null) return true;

        String currentMode = mode.getSelected();

        // === MODE-BASED PACKET HANDLING ===

        // Verus mode: Cancel sprint packets
        if (currentMode.equals(MODE_VERUS)) {
            if (packet instanceof C0BPacketEntityAction) {
                C0BPacketEntityAction c0b = (C0BPacketEntityAction) packet;
                C0BPacketEntityAction.Action action = c0b.getAction();
                if (action == C0BPacketEntityAction.Action.START_SPRINTING ||
                    action == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                    return false; // Cancel
                }
            }
        }

        // Verus2 mode: Queue transactions and keepalives for delayed sending
        if (currentMode.equals(MODE_VERUS2) && verus2Sprint.isEnabled()) {
            // Queue C0FPacketConfirmTransaction with 500ms delay
            if (packet instanceof C0FPacketConfirmTransaction) {
                verus2Transactions.add((C0FPacketConfirmTransaction) packet);
                verus2LastSend = System.currentTimeMillis();
                return false; // Cancel, will be sent later
            }

            // Queue C00PacketKeepAlive with 400ms delay
            if (packet instanceof C00PacketKeepAlive) {
                try {
                    C00PacketKeepAlive keepAlive = (C00PacketKeepAlive) packet;
                    int key = keepAlive.getKey();
                    verus2KeepAlives.add(new DelayedPacket(key, System.currentTimeMillis() + 400));
                    return false; // Cancel, will be sent later
                } catch (Exception e) {
                    // Silent
                }
            }

            // Cancel sprint packets (we send our own in onUpdate)
            if (packet instanceof C0BPacketEntityAction) {
                C0BPacketEntityAction c0b = (C0BPacketEntityAction) packet;
                C0BPacketEntityAction.Action action = c0b.getAction();
                if (action == C0BPacketEntityAction.Action.START_SPRINTING ||
                    action == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                    return false; // Cancel
                }
            }
        }

        // Verus3 mode (Gothaj): Queue transactions, handle sprint when using item
        if (currentMode.equals(MODE_VERUS3)) {
            // Queue C0FPacketConfirmTransaction
            if (packet instanceof C0FPacketConfirmTransaction) {
                gothajPackets.add((C0FPacketConfirmTransaction) packet);

                // When queue reaches 200, start sending and set disabled flag
                while (gothajPackets.size() > 200) {
                    if (player.sendQueue != null) {
                        player.sendQueue.addToSendQueue(gothajPackets.remove(0));
                    }
                    gothajDisabled = true;
                }
                return false; // Cancel, will be sent later
            }

            // Handle sprint when using item
            if (player.isUsingItem() && player.isSprinting()) {
                if (!gothajUsingItem) {
                    // First tick of using item while sprinting - send stop sprint
                    if (player.sendQueue != null) {
                        player.sendQueue.addToSendQueue(
                            new C0BPacketEntityAction(player, C0BPacketEntityAction.Action.STOP_SPRINTING)
                        );
                    }
                    gothajUsingItem = true;
                }

                // Cancel sprint packets while using item
                if (packet instanceof C0BPacketEntityAction) {
                    C0BPacketEntityAction c0b = (C0BPacketEntityAction) packet;
                    C0BPacketEntityAction.Action action = c0b.getAction();
                    if (action == C0BPacketEntityAction.Action.START_SPRINTING ||
                        action == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                        return false; // Cancel
                    }
                }
            } else {
                gothajUsingItem = false;
            }
        }

        // C06->C04 mode: Convert PosLook to Position only
        if (currentMode.equals(MODE_C06_TO_C04)) {
            if (packet instanceof C03PacketPlayer.C06PacketPlayerPosLook) {
                try {
                    C03PacketPlayer.C06PacketPlayerPosLook c06 = (C03PacketPlayer.C06PacketPlayerPosLook) packet;
                    double x = c06PosXField != null ? c06PosXField.getDouble(c06) : player.posX;
                    double y = c06PosYField != null ? c06PosYField.getDouble(c06) : player.posY;
                    double z = c06PosZField != null ? c06PosZField.getDouble(c06) : player.posZ;
                    boolean onGround = c06OnGroundField != null ? c06OnGroundField.getBoolean(c06) : player.onGround;

                    // Send C04 instead
                    if (player.sendQueue != null) {
                        player.sendQueue.addToSendQueue(
                            new C03PacketPlayer.C04PacketPlayerPosition(x, y, z, onGround)
                        );
                    }
                    return false; // Cancel original
                } catch (Exception e) {
                    // Silent
                }
            }
        }

        // C04->C06 mode: Convert Position to PosLook
        if (currentMode.equals(MODE_C04_TO_C06)) {
            if (packet instanceof C03PacketPlayer.C04PacketPlayerPosition) {
                try {
                    C03PacketPlayer.C04PacketPlayerPosition c04 = (C03PacketPlayer.C04PacketPlayerPosition) packet;
                    double x = c04PosXField != null ? c04PosXField.getDouble(c04) : player.posX;
                    double y = c04PosYField != null ? c04PosYField.getDouble(c04) : player.posY;
                    double z = c04PosZField != null ? c04PosZField.getDouble(c04) : player.posZ;
                    boolean onGround = c04OnGroundField != null ? c04OnGroundField.getBoolean(c04) : player.onGround;

                    // Send C06 instead
                    if (player.sendQueue != null) {
                        player.sendQueue.addToSendQueue(
                            new C03PacketPlayer.C06PacketPlayerPosLook(x, y, z, player.rotationYaw, player.rotationPitch, onGround)
                        );
                    }
                    return false; // Cancel original
                } catch (Exception e) {
                    // Silent
                }
            }
        }

        // === PACKET CANCELLATION OPTIONS ===

        // PingSpoof: Delay KeepAlive packets
        if (pingSpoof.isEnabled() && packet instanceof C00PacketKeepAlive) {
            try {
                C00PacketKeepAlive keepAlive = (C00PacketKeepAlive) packet;
                int key = keepAlive.getKey();
                long delay = (long) pingSpoofDelay.getValue() + random.nextInt(200);
                delayedKeepAlives.add(new DelayedPacket(key, System.currentTimeMillis() + delay));
                return false; // Cancel, will be sent later
            } catch (Exception e) {
                // Silent
            }
        }

        // Cancel C01PacketPing
        if (cancelC01Ping.isEnabled() && packet instanceof C01PacketPing) {
            return false;
        }

        // Cancel C13PacketPlayerAbilities
        if (cancelC13Abilities.isEnabled() && packet instanceof C13PacketPlayerAbilities) {
            return false;
        }

        // Cancel C0FPacketConfirmTransaction
        if (cancelC0FTransaction.isEnabled() && packet instanceof C0FPacketConfirmTransaction) {
            return false;
        }

        // Cancel C0BPacketEntityAction (if option enabled, separate from Verus mode)
        if (cancelC0BEntityAction.isEnabled() && packet instanceof C0BPacketEntityAction) {
            return false;
        }

        return true;
    }

    private void setClientBrand(EntityPlayerSP player, String brand) {
        try {
            if (clientBrandField != null) {
                clientBrandField.set(player, brand);
            }
        } catch (Exception e) {
            // Silent
        }
    }

    @Override
    public String getDisplaySuffix() {
        return " ยง7" + mode.getSelected();
    }

    /**
     * Helper class for delayed packets
     */
    private static class DelayedPacket {
        final int key;
        final long sendTime;

        DelayedPacket(int key, long sendTime) {
            this.key = key;
            this.sendTime = sendTime;
        }
    }
}
